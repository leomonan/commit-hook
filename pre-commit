#!/bin/bash
# 文件名: pre-commit
# 描述: pre-commit 钩子 - 代码提交前检查
# 创建日期: 2026年01月25日 15:32:00
# 最后更新日期: 2026年02月02日 00:01:15

set -e

# 钩子脚本所在目录（支持独立项目 commit-hooks 或仓库内 scripts/hooks）
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
GIT_ROOT="$(git rev-parse --show-toplevel)"

source "${SCRIPT_DIR}/config.sh"

# 统一到仓库根目录执行，避免在子目录 git commit 时相对路径不一致导致漏检
cd "${GIT_ROOT}"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 打印 hook 参数帮助提示
print_hooks_help_hint() {
    echo -e "${YELLOW}提示：${NC}AUTOMANUS_HOOKS_HELP=1 git commit 可查看所有 hook 参数用法"
}

# 打印 hook 参数帮助后退出（不执行检查、不提交）
case "$(echo "${AUTOMANUS_HOOKS_HELP:-}" | tr 'A-Z' 'a-z')" in
    1|true|yes)
        echo "Git Commit Hooks 环境变量"
        echo ""
        echo "  AUTOMANUS_NO_REVIEW=1"
        echo "    跳过 LLM Review。示例: AUTOMANUS_NO_REVIEW=1 git commit -m \"feat: xxx\""
        echo ""
        echo "  AUTOMANUS_LLM_REVIEW_FORCE=1|true|yes"
        echo "    强制 LLM Review（跳过缓存）。示例: AUTOMANUS_LLM_REVIEW_FORCE=1 git commit -m \"feat: xxx\""
        echo ""
        echo "  AUTOMANUS_LLM_REVIEW_PRINT_PROMPT=1|true|yes"
        echo "    打印 LLM Review 完整提示词（调试用）。"
        echo ""
        echo "  AUTOMANUS_HOOKS_HELP=1|true|yes"
        echo "    打印本帮助并退出，不执行提交。"
        echo ""
        echo "  AUTOMANUS_INTERACTIVE=1|true|yes"
        echo "    启用交互模式，每个检查步骤前询问是否执行。示例: AUTOMANUS_INTERACTIVE=1 git commit -m \"feat: xxx\""
        echo ""
        echo "  git commit --no-verify"
        echo "    跳过所有 hooks（含 pre-commit、commit-msg）。"
        echo ""
        echo -e "${YELLOW}此次仅显示帮助，未执行提交。移除 AUTOMANUS_HOOKS_HELP 即可正常提交。${NC}"
        exit 1
        ;;
esac

echo -e "${GREEN}[pre-commit]${NC} 开始检查..."

# 检测交互模式（默认关闭；仅当显式设置 AUTOMANUS_INTERACTIVE=1/true/yes 才启用）
INTERACTIVE_MODE=false
case "$(echo "${AUTOMANUS_INTERACTIVE:-}" | tr 'A-Z' 'a-z')" in
    1|true|yes)
        INTERACTIVE_MODE=true
        ;;
esac

# 交互式询问函数
ask_continue() {
    local check_name="$1"
    if [[ "$INTERACTIVE_MODE" == "true" ]]; then
        echo ""
        echo -e "${YELLOW}是否执行检查: ${check_name}?${NC} [Y/n] "
        read -r response < /dev/tty 2>/dev/null || response="y"
        case "$(echo "$response" | tr 'A-Z' 'a-z')" in
            n|no)
                echo -e "${YELLOW}[pre-commit]${NC} 已跳过: ${check_name}"
                return 1
                ;;
            *)
                return 0
                ;;
        esac
    fi
    return 0
}

# 检测并使用项目虚拟环境（与 install.sh 保持一致）
PYTHON_CMD="python3"
if [[ -f "${GIT_ROOT}/.venv/bin/python" ]]; then
    PYTHON_CMD="${GIT_ROOT}/.venv/bin/python"
fi

# 1. 敏感文件检测（阻断）
if ask_continue "敏感文件检测"; then
    source "${SCRIPT_DIR}/lib/check_sensitive.sh"
    check_sensitive_files || { print_hooks_help_hint; exit 1; }
fi

# 2. 命名模式检测（阻断）
if ask_continue "命名模式检测"; then
    source "${SCRIPT_DIR}/lib/check_naming.sh"
    check_naming_patterns || { print_hooks_help_hint; exit 1; }
fi

# 3. 文件头检测（阻断）
if ask_continue "文件头检测"; then
    ${PYTHON_CMD} "${SCRIPT_DIR}/lib/check_header.py" || { print_hooks_help_hint; exit 1; }
fi

# 4. Python 代码格式化检查（black）
if ask_continue "Python 代码格式化检查"; then
    ${PYTHON_CMD} "${SCRIPT_DIR}/lib/check_format.py" || { print_hooks_help_hint; exit 1; }
fi

# 5. Shell 脚本检查（shellcheck）
if ask_continue "Shell 脚本检查"; then
    source "${SCRIPT_DIR}/lib/check_shell.sh" || { print_hooks_help_hint; exit 1; }
    # 注意：check_shell.sh 在被 source 时会自动执行 check_shell_scripts 函数
fi

# 6. 禁止静默吞异常（阻断）
if ask_continue "禁止静默吞异常检测"; then
    # 仅检查暂存区（staged）中本次提交涉及的 Python 文件，避免一次性要求清理全仓库历史遗留。
    # 注意：macOS 自带 bash 通常为 3.2，不支持 mapfile，因此使用 while read 兼容实现
    STAGED_PY_FILES=()
    while IFS= read -r f; do
        [[ -n "$f" ]] && STAGED_PY_FILES+=("$f")
    done < <(git diff --cached --name-only --diff-filter=ACMRT | awk 'NF && $0 ~ /\.py$/ {print}')
    if [[ ${#STAGED_PY_FILES[@]} -eq 0 ]]; then
        echo -e "${YELLOW}[pre-commit]${NC} 无暂存 Python 文件，跳过: 禁止静默吞异常检测"
    else
        ${PYTHON_CMD} "${SCRIPT_DIR}/lib/check_no_silent_excepts.py" --staged --files "${STAGED_PY_FILES[@]}" || { print_hooks_help_hint; exit 1; }
    fi
fi

echo -e "${GREEN}[pre-commit]${NC} 检查通过"
# 注意：提示信息由 commit-msg hook 统一打印（SSOT 原则）
exit 0
